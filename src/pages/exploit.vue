<template>
  <div class="wrap">
    <div class="top">
      <img @click="back" class="back_img" src="../assets/nav_back.png" alt>
      <div>{{$t('mining.ing')}}</div>
    </div>

    <div class="coin_div">
      <x-table :content-bordered="false" :cell-bordered="false">
        <thead>
          <tr>
            <th>{{$t('mining.mininglist.t1')}}</th>
            <th>{{$t('mining.mininglist.t2')}}</th>
            <th>{{$t('mining.mininglist.t3')}}</th>
            <th>{{$t('mining.mininglist.t4')}}</th>
            <th>{{$t('mining.mininglist.t5')}}</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(item,index) in list" :key="index">
            <td>{{item.name}}</td>
            <td>
              <!-- <van-switch
                :value="item.status"
                size="26px"
                active-color="#fcb90b"
                inactive-color="#f0f0f0"
                @click.native="onInput(index)"
              /> -->
              <van-switch
                :value="item.status"
                size="26px"
                active-color="#fcb90b"
                inactive-color="#f0f0f0"
                disabled
              />
            </td>
            <td>{{item.amount}}USD</td>
            <td>{{item.surplus}}</td>
            <td>{{item.power}}</td>
          </tr>
        </tbody>
      </x-table>

      <div v-if="list.length!=5" class="add_div f_c" @click="add">
        <span class="iconfont icon-jia f_c"></span>
        {{$t('mining.btn.b3')}}
      </div>
    </div>
    <x-dialog v-model="show" class="de_dialog no_dialog" hide-on-blur>
      <div class="dialog">
        <div class="no_title">
          <span class="iconfont icon-icon_wrong" @click="show=false"></span>
        </div>
        <div class="no_con">
          <div class="form">
            <div>
              <span class="f_l">{{$t('mining.dialog.l1')}}：</span>
              <div class="f_r">
                <span class="span">{{min}}-{{max}} USD</span>
              </div>
            </div>
            <div>
              <span class="f_l">{{$t('mining.dialog.l2')}}：</span>
              <div class="f_r">
                <input
                  type="number"
                  v-model="number"
                  @input="num"
                  :placeholder="$t('mining.dialog.p3')"
                >
                <!-- <span class="spans">金额：
                  <inline-loading v-if="calc"></inline-loading>
                  <span v-if="!calc">{{number1}}</span> USD
                </span>-->
              </div>
            </div>
            <div>
              <span class="f_l">{{$t('mining.dialog.l3')}}：</span>
              <div class="f_r">
                <input type="password" v-model="pwd" :placeholder="$t('mining.dialog.p2')">
              </div>
            </div>
          </div>
        </div>
        <div class="no_btn">
          <button class="btn" @click="addSub">{{$t('mining.btn.b4')}}</button>
        </div>
      </div>
    </x-dialog>
  </div>
</template>
<script>
import $ from "jquery";
import { Switch } from "vant";
import { XTable, XDialog, InlineLoading, debounce } from "vux";
export default {
  data() {
    return {
      show: false,
      type: 1,
      value: false,
      number: "",
      number1: "0.00",
      pwd: "",
      list: [],
      calc: false,
      min: "",
      max: ""
    };
  },
  components: {
    InlineLoading,
    XTable,
    XDialog,
    "van-switch": Switch
  },
  created() {
    this.num = debounce(this.fnHandle, 1000);
  },
  mounted() {
    let that = this;
    mui.back = function() {
      that.$router.back();
      error;
    };
  },
  activated() {
    let that = this;
    that.number = "";
    that.calc = false;
    that.getList();
    that
      .$http({
        url: "/user/mining_config",
        method: "post",
        data: {
          token: that.$store.state.user_info.token
        }
      })
      .then(function(res) {
        if (res.data.code == 1) {
          that.min = res.data.data.min;
          that.max = res.data.data.max;
        } else {
          that.$vux.toast.show({
            text: res.data.msg,
            type: "cancel",
            position: "middle",
            time: 1200
          });
        }
      });
  },
  methods: {
    back() {
      this.$router.back();
    },
    getList() {
      // 矿机列表
      let that = this;
      that
        .$http({
          url: "/user/get_user_mining",
          method: "post",
          data: {
            token: that.$store.state.user_info.token
          }
        })
        .then(function(res) {
          if (res.data.code == 1) {
            if (res.data.data.length > 0) {
              for (let v of res.data.data) {
                v.status = Boolean(v.status);
              }
              that.list = res.data.data;
            }
          } else {
            that.$vux.toast.show({
              text: res.data.msg,
              type: "cancel",
              position: "middle",
              time: 1200
            });
          }
        });
    },
    onInput(i) {
      let that = this;
      that.$vux.loading.show({
        text: ""
      });
      that
        .$http({
          url: "/user/change_mining",
          method: "post",
          data: {
            token: that.$store.state.user_info.token,
            mining_number: that.list[i].id
          }
        })
        .then(function(res) {
          that.$vux.loading.hide();
          if (res.data.code == 1) {
            that.list[i].status = !that.list[i].status;
          } else {
            that.$vux.toast.show({
              text: res.data.msg,
              type: "cancel",
              position: "middle",
              time: 1200
            });
          }
        });
    },
    add() {
      this.show = true;
    },
    fnHandle(e) {
      let that = this;
      if (!parseFloat(that.number) || that.number.split(".").length > 2) {
        that.$vux.toast.show({
          text: that.tip.num_error,
          type: "text",
          position: "middle",
          time: 1000
        });
        that.number1 = "0.00";
        return false;
      }
      that.calc = true;
    },
    addSub() {
      let that = this;
      if (
        !parseFloat(that.number) ||
        that.number.split(".").length > 2 ||
        parseFloat(that.number) < that.min ||
        parseFloat(that.number) > that.max
      ) {
        that.$vux.toast.show({
          text: that.$t("tip.num_error"),
          type: "cancel",
          position: "middle",
          time: 1000
        });
        return false;
      }
      if (that.pwd) {
        that.$vux.loading.show({
          text: ""
        });
        that
          .$http({
            url: "/user/add_mining",
            method: "post",
            data: {
              token: that.$store.state.user_info.token,
              mining_number: that.number,
              payment_password: that.pwd
            }
          })
          .then(function(res) {
            that.$vux.loading.hide();
            if (res.data.code == 1) {
              that.number = "";
              that.pwd = "";
              that.show = false;
              that.getList();
              that
                .$http({
                  url: "/user/mining_config",
                  method: "post",
                  data: {
                    token: that.$store.state.user_info.token
                  }
                })
                .then(function(res) {
                  if (res.data.code == 1) {
                    that.min = res.data.data.min;
                    that.max = res.data.data.max;
                  } else {
                    that.$vux.toast.show({
                      text: res.data.msg,
                      type: "cancel",
                      position: "middle",
                      time: 1200
                    });
                  }
                });
            } else {
              that.$vux.toast.show({
                text: res.data.msg,
                type: "cancel",
                position: "middle",
                time: 1200
              });
            }
          });
      } else {
        that.$vux.toast.show({
          text: that.$t("tip.full_tip"),
          type: "cancel",
          position: "middle",
          time: 1200
        });
      }
    }
  }
};
</script>
<style lang="less" scoped>
.wrap {
  font-size: 0.36rem;
  width: 100%;
  height: 100%;
  color: white;
  box-sizing: border-box;
  padding: 1.3rem 0 1.5rem;
  overflow: auto;
  .top {
    background: #1a212a;
  }
  .add_div {
    text-align: center;
    padding: 0.8rem 0 0.2rem;
    font-size: 0.44rem;
    .iconfont {
      font-size: 1rem;
      display: inline-block;
      vertical-align: sub;
      transform: translateY(2px);
      margin-right: 0.1rem;
    }
  }
  .coin_div {
    background: #1a212a;
    padding-bottom: 0.5rem;
    .vux-table th {
      background: #161d26;
    }
    .vux-table td {
      border-bottom: 1px solid #2a333e;
    }
    .vux-table td:nth-child(2) {
      padding: 0.38rem 0 0.22rem;
    }
  }
  .no_dialog {
    ::-webkit-input-placeholder {
      color: rgb(121, 120, 120);
    }
    ::-moz-input-placeholder {
     color: rgb(121, 120, 120);
    }
    ::-o-input-placeholder {
      color: rgb(121, 120, 120);
    }
    ::-ms-input-placeholder {
      color: rgb(121, 120, 120);
    }
    color: #2a333e;
    .no_title {
      position: relative;
      padding: 0.3rem 0 0.3rem;
      height: 1.2rem;
      box-sizing: border-box;
      .iconfont {
        position: absolute;
        font-size: 0.7rem;
        color: #101010;
        right: 0.3rem;
        top: 0.2rem;
      }
    }
    .no_con {
      .form {
        padding: 0 0.4rem 0;
        > div {
          overflow: hidden;
          margin-bottom: 0.4rem;
          > .f_l:first-child {
            width: 2rem;
            line-height: 0.9rem;
          }
          > .f_r {
            width: calc(100% - 2rem);
            text-align: left;
            input {
              line-height: 0.9rem;
              height: 0.9rem;
              border: 1px solid #aab1b7;
              width: 100%;
              padding: 0 0.2rem 0;
              box-sizing: border-box;
            }
            > .span {
              line-height: 0.9rem;
            }
            > .spans {
              display: block;
              font-size: 0.34rem;
              padding-top: 0.1rem;
              color: #878893;
            }
          }
        }
      }
    }
    .no_btn {
      padding: 0.4rem 0.4rem 0.6rem;
      .btn {
        display: block;
        width: 100%;
        line-height: 0.8rem;
        text-align: center;
        color: #fcb90b;
        border-radius: 4px;
        background: transparent;
        border: 1px solid #fcb90b;
      }
      .btn:active {
        background: #f0f0f0;
      }
    }
  }
}
</style>
